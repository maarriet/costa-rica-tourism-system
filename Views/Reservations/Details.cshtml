@model ReservationViewModel
@{
    ViewData["Title"] = $"Detalles - {Model.ReservationCode}";
    // Calculate days for pricing
    var days = 1;
    if (Model.EndDate.HasValue)
    {
        days = (Model.EndDate.Value - Model.StartDate).Days;
        if (days <= 0) days = 1;
    }
    var subtotal = Model.PlacePrice * days;
    
    string GetStatusClass(ReservationStatus status) => status switch
    {
        ReservationStatus.Confirmed => "status-available",
        ReservationStatus.Pending => "status-maintenance", 
        ReservationStatus.Cancelled => "status-inactive",
        ReservationStatus.Completed => "status-busy",
        _ => "status-inactive"
    };

    string GetStatusText(ReservationStatus status) => status switch
    {
        ReservationStatus.Confirmed => "Confirmada",
        ReservationStatus.Pending => "Pendiente",
        ReservationStatus.Cancelled => "Cancelada", 
        ReservationStatus.Completed => "Completada",
        _ => "Desconocido"
    };
}

@section Styles {
    <link href="~/css/styles.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
}

<div class="container">
    <div class="section-header">
        <h2><i class="fas fa-eye"></i> Detalles de la Reserva</h2>
        <div class="section-actions">
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar
            </a>
            <button class="btn btn-info" onclick="printReservation()">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Lista
            </a>
        </div>
    </div>

    <div class="details-container">
        <!-- Main Reservation Card -->
        <div class="details-card main-info">
            <div class="card-header">
                <div class="reservation-title">
                    <div class="reservation-code-section">
                        <h1><i class="fas fa-ticket-alt"></i> @Model.ReservationCode</h1>
                        <div class="reservation-meta">
                            <span class="creation-date">Creada: @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>
                <div class="reservation-status">
                    <span class="status @GetStatusClass(Model.Status)">
                        @GetStatusText(Model.Status)
                    </span>
                </div>
            </div>

            <div class="card-body">
                <div class="info-grid">
                    <div class="info-section">
                        <h3><i class="fas fa-user"></i> Información del Cliente</h3>
                        <div class="info-items">
                            <div class="info-item">
                                <strong>Nombre:</strong>
                                <span>@Model.ClientName</span>
                            </div>
                            <div class="info-item">
                                <strong>Email:</strong>
                                <span><a href="mailto:@Model.ClientEmail">@Model.ClientEmail</a></span>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.ClientPhone))
                            {
                                <div class="info-item">
                                    <strong>Teléfono:</strong>
                                    <span><a href="tel:@Model.ClientPhone">@Model.ClientPhone</a></span>
                                </div>
                            }
                            <div class="info-item">
                                <strong>Número de Personas:</strong>
                                <span><i class="fas fa-users"></i> @Model.NumberOfPeople</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3><i class="fas fa-map-marker-alt"></i> Lugar y Fechas</h3>
                        <div class="info-items">
                            <div class="info-item">
                                <strong>Lugar:</strong>
                                <span>@Model.PlaceName</span>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.CategoryName))
                            {
                                <div class="info-item">
                                    <strong>Categoría:</strong>
                                    <span class="badge badge-secondary">@Model.CategoryName</span>
                                </div>
                            }
                            <div class="info-item">
                                <strong>Fecha de Inicio:</strong>
                                <span>@Model.StartDate.ToString("dddd, dd 'de' MMMM 'de' yyyy")</span>
                                @if (Model.StartTime.HasValue)
                                {
                                    <span class="time-info">a las @Model.StartTime.Value.ToString(@"hh\:mm")</span>
                                }
                            </div>
                            @if (Model.EndDate.HasValue)
                            {
                                <div class="info-item">
                                    <strong>Fecha de Fin:</strong>
                                    <span>@Model.EndDate.Value.ToString("dddd, dd 'de' MMMM 'de' yyyy")</span>
                                    @if (Model.EndTime.HasValue)
                                    {
                                        <span class="time-info">a las @Model.EndTime.Value.ToString(@"hh\:mm")</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Information -->
        <div class="details-card pricing-info">
            <div class="card-header">
                <h3><i class="fas fa-dollar-sign"></i> Información de Precios</h3>
            </div>
            <div class="card-body">
                <div class="pricing-breakdown">
                    <div class="pricing-item">
                        <span class="pricing-label">Precio por día/noche:</span>
                        <span class="pricing-value">@Model.PlacePrice.ToString("C")</span>
                    </div>
                    @if (Model.EndDate.HasValue)
                    {
                        <div class="pricing-item">
                            <span class="pricing-label">Número de días:</span>
                            <span class="pricing-value">@days</span>
                        </div>
                        <div class="pricing-item">
                            <span class="pricing-label">Subtotal:</span>
                            <span class="pricing-value">@subtotal.ToString("C")</span>
                        </div>
                    }
                    <div class="pricing-item total-item">
                        <span class="pricing-label">Total:</span>
                        <span class="pricing-value total-amount">@Model.TotalAmount.ToString("C")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Information -->
        <div class="details-card timeline-info">
            <div class="card-header">
                <h3><i class="fas fa-clock"></i> Información de Tiempo</h3>
            </div>
            <div class="card-body">
                <div class="timeline-grid">
                    <div class="timeline-item">
                        <strong>Días hasta la reserva:</strong>
                        @if (Model.DaysUntilReservation >= 0)
                        {
                            <span class="days-until @(Model.DaysUntilReservation <= 3 ? "text-warning" : "text-success")">
                                @if (Model.DaysUntilReservation == 0)
                                {
                                    <strong>¡Hoy!</strong>
                                }
                                else if (Model.DaysUntilReservation == 1)
                                {
                                    <strong>Mañana</strong>
                                }
                                else
                                {
                                    <span>@Model.DaysUntilReservation días</span>
                                }
                            </span>
                        }
                        else
                        {
                            <span class="text-muted">Reserva pasada</span>
                        }
                    </div>
                    <div class="timeline-item">
                        <strong>Creada:</strong>
                        <span>@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="timeline-item">
                        <strong>Última actualización:</strong>
                        <span>@Model.UpdatedDate.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div class="details-card notes-info">
                <div class="card-header">
                    <h3><i class="fas fa-sticky-note"></i> Notas y Observaciones</h3>
                </div>
                <div class="card-body">
                    <div class="notes-content">
                        @Model.Notes
                    </div>
                </div>
            </div>
        }

        <!-- Quick Actions -->
        <div class="details-card quick-actions">
            <div class="card-header">
                <h3><i class="fas fa-bolt"></i> Acciones Rápidas</h3>
            </div>
            <div class="card-body">
                <div class="action-buttons-grid">
                    @if (Model.Status == ReservationStatus.Pending)
                    {
                        <button class="btn btn-success" onclick="confirmReservation(@Model.Id)">
                            <i class="fas fa-check"></i> Confirmar Reserva
                        </button>
                    }
                    @if (Model.Status != ReservationStatus.Cancelled && Model.Status != ReservationStatus.Completed)
                    {
                        <button class="btn btn-warning" onclick="sendReminder(@Model.Id)">
                            <i class="fas fa-bell"></i> Enviar Recordatorio
                        </button>
                    }
                    <button class="btn btn-info" onclick="sendConfirmationEmail(@Model.Id)">
                        <i class="fas fa-envelope"></i> Enviar Confirmación
                    </button>
                    @if (Model.Status == ReservationStatus.Confirmed && Model.DaysUntilReservation <= 0)
                    {
                        <button class="btn btn-primary" onclick="markAsCompleted(@Model.Id)">
                            <i class="fas fa-flag-checkered"></i> Marcar Completada
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/tourism-system.js"></script>
    <script>
        function confirmReservation(reservationId) {
            if (confirm('¿Confirmar esta reserva?')) {
                fetch(`/Reservations/Confirm/${reservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => {
                    if (response.ok) location.reload();
                });
            }
        }

        function markAsCompleted(reservationId) {
            if (confirm('¿Marcar esta reserva como completada?')) {
                fetch(`/Reservations/Complete/${reservationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => {
                    if (response.ok) location.reload();
                });
            }
        }

        function sendReminder(reservationId) {
            fetch(`/Reservations/SendReminder/${reservationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => {
                if (response.ok) {
                    alert('Recordatorio enviado exitosamente');
                } else {
                    alert('Error al enviar recordatorio');
                }
            });
        }

        function sendConfirmationEmail(reservationId) {
            fetch(`/Reservations/SendConfirmation/${reservationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => {
                if (response.ok) {
                    alert('Email de confirmación enviado');
                } else {
                    alert('Error al enviar email');
                }
            });
        }

        function printReservation() {
            window.print();
        }
    </script>
}